import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

import { Alert } from "@site/src/components/shared/Alert";
import GettingStartedSection from "@site/src/components/docs/_getting-started-section.mdx";
import ConfigureElementsSection from "@site/src/components/docs/_configure-elements-section.mdx";

# Collect Verified Bank Accounts

In this guide, we will set up PublicSquare Elements SDKs to capture instantly verified bank accounts in a frontend application, securely authorize them, and store the bank account data while avoiding PCI requirements.

## Getting Started

<GettingStartedSection />

### Get your Publishable Key

Next you will need your `Publishable Key`. [Go to your Developers section](https://portal.publicsquare.com/developers/api-keys) and click `Reveal` for your `Publishable Key` and copy the value.

<Alert>Save the Publishable Key as it will be used in the next steps of this guide.</Alert>

## Request Account Setting Access

First, you will need to request access to the `payment-methods:bank-accounts:verification` account setting type. 

To do this, go to the [merchant portal](https://portal.publicsquare.com/settings/features) and click on the `Request this feature` button next to the `Bank Account Verification` setting.
Alternatively, you can request access via the [API](/api/accounts/request-account-setting-access).

This is required to enable instant bank account verification for your account.

## Configuring PublicSquare Elements

<ConfigureElementsSection />

## Adding Bank Account Verification Elements

PublicSquare has partnered with [Flinks](https://www.flinks.com/) to provide a secure way to collect bank accounts.
Once installed and configured, add the Bank Account Verification Elements to your application.

<Tabs className="publicsquare-tabs" queryString="sdk">
  <TabItem value="javascript" label="JavaScript">

```html showLineNumbers title="index.html"
<div id="bank-account-verification-element">
  <button
    onclick={onConnectBankAccountWithVerification}
  >
    Connect Bank Account
  </button>
</div>
```

```javascript showLineNumbers title="index.js"
import { PublicSquare } from '@publicsquare/elements-js';

let publicsquare;
let result;

async function init() {
  publicsquare = await new PublicSquare().init('<PUBLISHABLE_API_KEY>');

  async function onConnectBankAccountWithVerification() {
    result = await publicsquare?.bankAccounts.openVerification(
      `#${'bank-account-verification-element'}`
    )
  }
}

await init();
```
  </TabItem>
  <TabItem value="react" label="React">
```jsx showLineNumbers title="App.jsx"
import React, { useRef } from 'react';
import {
  PublicSquareProvider,
  BankAccountVerificationElement,
  usePublicSquare,
} from '@publicsquare/elements-react';

export default function App() {
  const { publicsquare } = usePublicSquare();
  // Refs to get access to the Elements instance
  const bankAccountVerificationElementRef = useRef(null);

  return (
    <PublicSquareProvider apiKey={apiKey}>
        <BankAccountVerificationElement
          id="bankAccountVerificationElement"
          ref={bankAccountVerificationElementRef}
          onVerificationComplete={(result) => {
            console.log('Bank account verification completed:', result.bank_account_verification_id);
          }}
        />
    </PublicSquareProvider>
  );
}
```
  </TabItem>
</Tabs>

## Storing Bank Accounts

Now that your customer has verified their bank account information, we need to create a bank account payment method from the results.

To do this, we will call the `create bank account` method from the SDK passing the `bank_account_verification_id`, returned from the bank account verification result.

Add a submit function along with a button to trigger it:

<Tabs className="publicsquare-tabs" queryString="sdk">
  <TabItem value="javascript" label="JavaScript">
  
```html showLineNumbers title="index.html"
<div id="bank-account-verification-element">
  <button
    onclick={onConnectBankAccountWithVerification}
  >
    Connect Bank Account
  </button>
</div>

// highlight-next-line
<button id="submit">Submit</button>
```

```javascript showLineNumbers title=index.js
import { PublicSquare } from '@publicsquare/elements-js';

let publicsquare;
let result;

async function init () {
  publicsquare = await new PublicSquare().init('<PUBLISHABLE_API_KEY>');

  async function onConnectBankAccountWithVerification() {
    result = await publicsquare?.bankAccounts.openVerification(
      `#${'bank-account-verification-element'}`
    )
  }
  
  //highlight-next-line
  document.getElementById("submit").addEventListener("click", submit);
}

// highlight-start
async function submit (e: FormEvent<HTMLFormElement>,) {
  try {
    const bankAccount = await publicsquare?.bankAccounts.create({
      bank_account_verification_id: result?.bank_account_verification_id
    });
    console.log(bankAccount); // e.g { id: 'ba_1234567890', ... }
  } catch (error) {
    console.error(error);
  }
}
// highlight-end

await init();
```
  </TabItem>
  <TabItem value="react" label="React">

```jsx showLineNumbers title=App.jsx
import React, { useRef } from 'react';
import {
  PublicSquareProvider,
  BankAccountVerificationElement,
  usePublicSquare,
} from '@publicsquare/elements-react';

export default function App() {
  const { publicsquare } = usePublicSquare();
  // Refs to get access to the Elements instance
  const bankAccountVerificationElementRef = useRef(null);

  // highlight-start
  const submit = async () => {
    try {
      const bankAccount = await publicsquare.bankAccounts.create({
        bank_account_verification_id: bankAccountVerificationElementRef.current.bank_account_verification_id
      });
      console.log(bankAccount); // e.g { id: 'ba_1234567890', ... }
    } catch (error) {
      console.error(error);
    }
  }
  // highlight-end

  return (
    <PublicSquareProvider apiKey={apiKey}>
      <BankAccountVerificationElement
        id="bankAccountVerificationElement"
        ref={bankAccountVerificationElementRef}
        onVerificationComplete={(result) => {
          console.log('Bank account verification completed:', result.bank_account_verification_id);
        }}
      />
      // highlight-next-line
      <button onClick={submit}>Submit</button>
    </PublicSquareProvider>
  );
}
```
  </TabItem>
</Tabs>

The created `bank account` object contains the non-sensitive information about the bank account:

```json showLineNumbers title=bankAccount.json
{
  "id": "ba_7Ay5mcUXAxwrN6wQEQUVEHBCJ",
  "account_id": "acc_B518niGwGYKzig6vtrRVZGGGV",
  "environment": "production",
  "customer_id": "cus_7Ay5mcUXAxwrN6wQEQUVEHBCJ",
  "billing_details": {
    "address_line_1": "111 Colorado Ave.",
    "address_line_2": "Apt 403",
    "city": "Des Moines",
    "state": "IA",
    "postal_code": "51111",
    "country": "US"
  },
  "created_at": "2024-06-30T01:02:29.212Z",
  "modified_at": "2024-06-30T01:02:29.212Z",
  "account_holder_name": "John Doe",
  "account_holder_type": "individual",
  "account_type": "checking",
  "routing_number": "110000000",
  "account_number_last4": "1011"
}
```
<Alert>If PublicSquare has not yet received a response back from Flinks, we will return `bank account verification result is still in progress.` validation message.</Alert>

You can safely store the bank account's `id` value in your database to link it with the appropriate payment or customer association.

You can optionally pass in a `customer_id` to associate with an existing [Created Customer](/api/accounts/create-customer) and `billing_details` to remove the requirement to pass them when [Creating a Payment](/api/financial/create-payment).

## Conclusion

Following this guide, you have successfully verified a customer's bank account. To use this bank account, proceed with the [Process ACH Payments](/guides/payments/process-ach-payments) guide.
